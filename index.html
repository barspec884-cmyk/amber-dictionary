<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amber Palette Dictionary - Mobile Optimized</title>
    <style>
        :root {
            --amber-dark: #1a120b;
            --amber-mid: #2c1e17;
            --amber-gold: #d4a373;
            --amber-bright: #faedcd;
            --text-main: #fefae0;
            --color-tasting: #d4a373;
            --color-distillation: #cd7f32;
            --color-maturation: #8b4513;
            --color-raw: #e9c46a;
        }

        body {
            background-color: var(--amber-dark);
            color: var(--text-main);
            font-family: sans-serif;
            margin: 0;
            padding: 15px;
            line-height: 1.6;
        }

        .container { max-width: 800px; margin: 0 auto; }

        h1 { text-align: center; color: var(--amber-gold); font-size: 1.5em; }

        .search-box {
            width: 100%;
            padding: 12px 20px;
            border-radius: 25px;
            border: 2px solid var(--amber-gold);
            background: var(--amber-mid);
            color: white;
            font-size: 1em;
            box-sizing: border-box;
            outline: none;
            margin-bottom: 20px;
        }

        /* 2階層タグインデックス（アコーディオン） */
        .tag-index-container {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(212, 163, 115, 0.3);
            border-radius: 8px;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .tag-group {
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        /* カテゴリーヘッダー（タップ領域） */
        .tag-group-label {
            width: 100%;
            padding: 12px 15px;
            font-size: 0.9em;
            font-weight: bold;
            color: var(--amber-gold);
            background: none;
            border: none;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .tag-group-label::after {
            content: '▶';
            font-size: 0.7em;
            transition: transform 0.3s;
        }

        /* 開いている時のスタイル */
        .tag-group.open .tag-group-label::after {
            transform: rotate(90deg);
        }

        /* タグ一覧（通常は非表示） */
        .tag-group-items {
            display: none;
            padding: 0 15px 15px;
            flex-wrap: wrap;
            gap: 8px;
            background: rgba(0,0,0,0.2);
        }

        .tag-group.open .tag-group-items {
            display: flex;
        }

        .btn-tag {
            background: var(--amber-mid);
            border: 1px solid rgba(212, 163, 115, 0.4);
            color: #ccc;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
        }

        /* 辞書カード */
        .dictionary-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .dic-card {
            background: var(--amber-mid);
            padding: 15px;
            border-radius: 8px;
            border-top: 4px solid var(--amber-gold);
        }
        .dic-card[data-cat="tasting"] { border-top-color: var(--color-tasting); }
        .dic-card[data-cat="distillation"] { border-top-color: var(--color-distillation); }
        .dic-card[data-cat="maturation"] { border-top-color: var(--color-maturation); }
        .dic-card[data-cat="raw"] { border-top-color: var(--color-raw); }

        .term-en { font-weight: bold; font-size: 1.1em; color: var(--amber-gold); }
        .term-jp { font-size: 0.85em; opacity: 0.8; }
        .desc { font-size: 0.9em; color: #ddd; margin: 10px 0; }
        .card-tag { color: var(--amber-gold); font-size: 0.8em; margin-right: 10px; text-decoration: none; }
        
        .highlight { background: rgba(212, 163, 115, 0.4); border-radius: 2px; }

        /* インデックス（スマホ用に少し大きく） */
        .index-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; margin-bottom: 10px; }
        .btn-index {
            background: var(--amber-mid);
            color: var(--amber-bright);
            border: 1px solid var(--amber-gold);
            padding: 6px 9px;
            border-radius: 4px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Amber Palette Dict</h1>

    <input type="text" id="dicSearch" class="search-box" placeholder="用語・説明・タグから検索...">

    <div class="nav-section">
        <div id="alphaIndex" class="index-row"></div>
        <div id="kanaIndex" class="index-row"></div>
    </div>

    <div class="tag-index-container" id="tagHierarchicalIndex"></div>

    <div id="dictionaryList" class="dictionary-grid"></div>
</div>

<script>
    let masterData = [];
    const categoryNames = {
        "tasting": "テイスティング表現",
        "distillation": "蒸留・設備",
        "maturation": "熟成・樽",
        "fermentation": "発酵・微生物",
        "raw": "原料・製麦",
        "finishing": "仕上げ・瓶詰め",
        "distribution": "流通・スタイル",
        "others": "その他"
    };

    async function init() {
        try {
            const res = await fetch('./dictionary-data.json');
            masterData = await res.json();
            createIndexNav();
            createTagAccordion();
            renderDictionary(masterData);
        } catch (e) {
            document.getElementById('dictionaryList').innerHTML = "JSONファイルを読み込めません。";
        }
    }

    function createIndexNav() {
        const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        const kana = "あかさたなはまやらわ".split(""); // スマホ用に主要な行のみ
        
        document.getElementById('alphaIndex').innerHTML = alpha.map(c => `<button class="btn-index" onclick="filterByChar('${c}', 'en')">${c}</button>`).join('');
        document.getElementById('kanaIndex').innerHTML = kana.map(c => `<button class="btn-index" onclick="filterByChar('${c}', 'jp')">${c}</button>`).join('');
    }

    // アコーディオン形式でタグインデックスを作成
    function createTagAccordion() {
        const tagMap = {};
        masterData.forEach(item => {
            if(!tagMap[item.category]) tagMap[item.category] = new Set();
            item.tags.forEach(t => { if(t) tagMap[item.category].add(t); });
        });

        const container = document.getElementById('tagHierarchicalIndex');
        container.innerHTML = Object.keys(tagMap).map(cat => `
            <div class="tag-group" id="group-${cat}">
                <button class="tag-group-label" onclick="toggleAccordion('${cat}')">
                    ${categoryNames[cat] || cat}
                </button>
                <div class="tag-group-items">
                    ${Array.from(tagMap[cat]).sort().map(tag => `
                        <button class="btn-tag" onclick="filterByTag('${tag}')">#${tag}</button>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    // 開閉切り替え
    function toggleAccordion(cat) {
        const el = document.getElementById(`group-${cat}`);
        const isOpen = el.classList.contains('open');
        
        // 他を全部閉じてから開く（シングルオープン形式）
        document.querySelectorAll('.tag-group').forEach(g => g.classList.remove('open'));
        
        if (!isOpen) {
            el.classList.add('open');
        }
    }

    function renderDictionary(data, query = "") {
        const list = document.getElementById('dictionaryList');
        list.innerHTML = data.map(item => `
            <div class="dic-card" data-cat="${item.category}">
                <div class="term-en">${highlight(item.term_en, query)}</div>
                <div class="term-jp">${highlight(item.term_jp, query)}</div>
                <p class="desc">${highlight(item.description, query)}</p>
                <div class="card-tags">
                    ${item.tags.map(tag => `<span class="card-tag" onclick="filterByTag('${tag}')">#${tag}</span>`).join('')}
                </div>
            </div>
        `).join('');
    }

    function highlight(text, q) {
        if (!q) return text;
        const re = new RegExp(`(${q})`, "gi");
        return text.replace(re, `<span class="highlight">$1</span>`);
    }

    document.getElementById('dicSearch').addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        const filtered = masterData.filter(item => 
            item.term_en.toLowerCase().includes(q) || 
            item.term_jp.includes(q) || 
            item.description.includes(q) ||
            item.tags.some(tag => tag.toLowerCase().includes(q))
        );
        renderDictionary(filtered, q);
    });

    function filterByTag(tag) {
        document.getElementById('dicSearch').value = tag;
        const filtered = masterData.filter(item => item.tags.includes(tag));
        renderDictionary(filtered, tag);
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function filterByChar(char, mode) {
        document.getElementById('dicSearch').value = "";
        const filtered = masterData.filter(item => {
            const target = (mode === 'en') ? item.term_en : item.term_jp;
            return target.toUpperCase().startsWith(char.toUpperCase());
        });
        renderDictionary(filtered);
    }

    init();
</script>

</body>
</html>