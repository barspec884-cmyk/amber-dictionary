<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amber Palette Dictionary - Full Edition</title>
    <style>
        :root {
            --amber-dark: #1a120b; --amber-mid: #2c1e17; --amber-gold: #d4a373;
            --amber-bright: #faedcd; --text-main: #fefae0;
            --color-tasting: #d4a373; --color-distillation: #cd7f32;
            --color-maturation: #8b4513; --color-raw: #e9c46a;
        }
        body { background-color: var(--amber-dark); color: var(--text-main); font-family: sans-serif; padding: 15px; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; color: var(--amber-gold); font-size: 1.5em; margin-bottom: 20px; }
        
        /* 検索窓 */
        .search-box { width: 100%; padding: 12px 20px; border-radius: 25px; border: 2px solid var(--amber-gold); background: var(--amber-mid); color: white; font-size: 1em; box-sizing: border-box; outline: none; margin-bottom: 20px; }
        
        /* インデックス（A-Z / あ-わ） */
        .index-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; margin-bottom: 10px; }
        .btn-index { background: var(--amber-mid); color: var(--amber-bright); border: 1px solid var(--amber-gold); padding: 7px 10px; border-radius: 4px; font-size: 0.85em; cursor: pointer; min-width: 35px; }
        .btn-index:hover, .btn-index.active { background: var(--amber-gold); color: black; }

        /* --- 4階層アコーディオン構造 --- */
        .tag-index-container { margin: 20px 0 25px 0; }
        
        /* 1階層目: ルート（カテゴリーから探す） */
        .main-category-root { border: 1.5px solid var(--amber-gold); border-radius: 6px; background: var(--amber-mid); overflow: hidden; }
        .btn-root-label { width: 100%; padding: 8px 12px; background: var(--amber-mid); color: var(--amber-gold); border: none; font-size: 0.95em; font-weight: bold; display: flex; align-items: center; cursor: pointer; }

        /* 2階層目: 各カテゴリー */
        .tag-group { border-top: 1px solid rgba(212, 163, 115, 0.15); }
        .tag-group-label { width: 100%; padding: 6px 12px 6px 20px; font-size: 0.85em; color: var(--amber-bright); background: rgba(255,255,255,0.02); border: none; display: flex; align-items: center; cursor: pointer; }

        /* 3階層目: タグ */
        .tag-sub-group { border-top: 1px solid rgba(255,255,255,0.05); }
        .btn-tag-expand { width: 100%; padding: 4px 12px 4px 35px; font-size: 0.8em; color: #bbb; background: none; border: none; display: flex; align-items: center; cursor: pointer; }

        /* 右揃え設定（カウントを矢印のすぐ左へ） */
        .cat-name, .tag-name, .root-name { margin-right: auto; }
        .count-num { font-size: 0.8em; opacity: 0.6; margin-right: 8px; font-weight: normal; font-family: monospace; }

        /* 矢印アイコン */
        .tag-group-label::after, .btn-tag-expand::after, .btn-root-label::after { content: '▶'; font-size: 0.6em; transition: transform 0.2s; color: var(--amber-gold); }
        .open > .tag-group-label::after, .open > .btn-tag-expand::after, .open > .btn-root-label::after { transform: rotate(90deg); }

        /* 4階層目: 単語（Word）リスト */
        .tag-term-list { display: none; padding: 2px 12px 6px 50px; background: rgba(0,0,0,0.15); }
        .open > .tag-term-list { display: block; }
        .term-link { display: block; color: var(--amber-gold); font-size: 0.75em; padding: 1px 0; text-decoration: none; opacity: 0.85; line-height: 1.3; }
        .term-link:hover { opacity: 1; text-decoration: underline; }

        /* 辞書カード表示 */
        .dictionary-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .dic-card { background: var(--amber-mid); padding: 15px; border-radius: 8px; border-top: 4px solid var(--amber-gold); }
        .dic-card[data-cat="tasting"] { border-top-color: var(--color-tasting); }
        .dic-card[data-cat="distillation"] { border-top-color: var(--color-distillation); }
        .dic-card[data-cat="maturation"] { border-top-color: var(--color-maturation); }
        .dic-card[data-cat="raw"] { border-top-color: var(--color-raw); }
        .term-en { font-weight: bold; font-size: 1.1em; color: var(--amber-gold); }
        .term-jp { font-size: 0.85em; opacity: 0.8; }
        .desc { font-size: 0.9em; color: #ddd; margin: 10px 0; }
        .card-tag { color: var(--amber-gold); font-size: 0.8em; margin-right: 10px; cursor: pointer; text-decoration: underline; }
        .highlight { background: rgba(212, 163, 115, 0.4); border-radius: 2px; }

        /* ステータスバー */
        .status-bar { background: rgba(212, 163, 115, 0.2); border-left: 5px solid var(--amber-gold); padding: 10px 15px; margin: 10px 0 20px 0; display: none; justify-content: space-between; align-items: center; border-radius: 4px; }
        .status-bar.show { display: flex; }
    </style>
</head>
<body>

<div class="container">
    <h1>Amber Palette Dictionary</h1>
    
    <input type="text" id="dicSearch" class="search-box" placeholder="単語・説明・タグから逆引き検索...">

    <div class="nav-section">
        <div id="alphaIndex" class="index-row"></div>
        <div id="kanaIndex" class="index-row"></div>
    </div>

    <div id="tagHierarchicalIndex" class="tag-index-container"></div>

    <div id="resultStatus" class="status-bar">
        <span id="statusMessage" style="font-weight: bold;"></span>
        <button onclick="resetSearch()" style="background:var(--amber-gold); border:none; padding:4px 12px; border-radius:4px; cursor:pointer; font-weight:bold;">解除</button>
    </div>

    <div id="dictionaryList" class="dictionary-grid"></div>
</div>

<script src="dictionary.js"></script>

<script>
    let masterData = [];
    const categoryNames = {
        "tasting": "テイスティング表現", "distillation": "蒸留・設備", "maturation": "熟成・樽",
        "fermentation": "発酵・微生物", "raw": "原料・製麦", "finishing": "仕上げ・瓶詰め",
        "distribution": "流通・スタイル", "others": "その他"
    };

    const kanaRows = {
        "あ": "あいうえおぁぃぅぇぉ", "か": "かきくけこがぎぐげご", "さ": "さしすせそざじずぜぞ",
        "た": "たちつてとだぢづでど", "な": "なにぬねの", "は": "はひふへほばびぶべぼぱぴぷぺぽ",
        "ま": "まみむめも", "や": "やゆよゃゅょ", "ら": "らりるれろ", "わ": "わをん"
    };

    function init() {
        if (typeof dictionaryData !== 'undefined') {
            masterData = dictionaryData; 
            createIndexNav();
            createTagAccordion();
            renderDictionary(masterData);
        } else {
            document.getElementById('dictionaryList').innerHTML = 
                "<div style='text-align:center; padding:20px;'>dictionary.js を読み込めません。</div>";
        }
    }

    // 4階層アコーディオンの生成
    function createTagAccordion() {
        const container = document.getElementById('tagHierarchicalIndex');
        if(!container) return;

        const structuredData = {};
        masterData.forEach(item => {
            if (!structuredData[item.category]) structuredData[item.category] = {};
            item.tags.forEach(tag => {
                if (!tag) return;
                if (!structuredData[item.category][tag]) structuredData[item.category][tag] = [];
                structuredData[item.category][tag].push(item);
            });
        });

        let html = `
            <div class="main-category-root" id="root-category-list">
                <button class="btn-root-label" onclick="toggleAccordion('root-category-list')">
                    <span class="root-name">カテゴリーから探す</span>
                    <span class="count-num">${Object.keys(structuredData).length} Categories</span>
                </button>
                <div class="tag-group-container" style="display:none;">
        `;

        html += Object.keys(structuredData).sort().map(cat => {
            const tags = structuredData[cat];
            const categoryId = `group-${cat}`.replace(/\s+/g, '-');
            return `
                <div class="tag-group" id="${categoryId}">
                    <button class="tag-group-label" onclick="toggleAccordion('${categoryId}')">
                        <span class="cat-name">${categoryNames[cat] || cat}</span>
                        <span class="count-num">${Object.keys(tags).length} Tags</span>
                    </button>
                    <div class="tag-sub-container" style="display:none;">
                        ${Object.keys(tags).sort().map(tagName => {
                            const items = tags[tagName];
                            const subGroupId = `sub-${cat}-${tagName}`.replace(/\s+/g, '-');
                            return `
                                <div class="tag-sub-group" id="${subGroupId}">
                                    <button class="btn-tag-expand" onclick="toggleAccordion('${subGroupId}')">
                                        <span class="tag-name">#${tagName}</span>
                                        <span class="count-num">${items.length}</span>
                                    </button>
                                    <div class="tag-term-list">
                                        ${items.map(item => `
                                            <a href="javascript:void(0)" class="term-link" onclick="filterBySingleWord('${item.term_en}')">
                                                ・${item.term_en}
                                            </a>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }).join('');

        html += `</div></div>`;
        container.innerHTML = html;
    }

    function toggleAccordion(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.toggle('open');
        const content = el.querySelector('.tag-group-container, .tag-sub-container, .tag-term-list');
        if (content) {
            content.style.display = (content.style.display === 'none' || content.style.display === '') ? 'block' : 'none';
        }
    }

    function filterBySingleWord(wordEn) {
        const filtered = masterData.filter(item => item.term_en === wordEn);
        renderDictionary(filtered, wordEn);
        finalizeFilter(`「${wordEn}」の詳細`);
    }

    // インデックス生成
    function createIndexNav() {
        const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        const kana = "あかさたなはまやらわ".split("");
        document.getElementById('alphaIndex').innerHTML = alpha.map(c => 
            `<button class="btn-index" onclick="filterByChar(event, '${c}', 'en')">${c}</button>`).join('');
        document.getElementById('kanaIndex').innerHTML = kana.map(c => 
            `<button class="btn-index" onclick="filterByChar(event, '${c}', 'jp')">${c}</button>`).join('');
    }

    function filterByChar(event, char, mode) {
        clearActiveStates();
        if (event && event.currentTarget) event.currentTarget.classList.add('active');
        const filtered = masterData.filter(item => {
            if (mode === 'en') return item.term_en.toUpperCase().startsWith(char.toUpperCase());
            const rowChars = kanaRows[char] || char;
            const target = item.reading || item.term_jp || "";
            return rowChars.includes(toHiragana(target.charAt(0)));
        });
        renderDictionary(filtered);
        finalizeFilter(`「${char}」行の結果: ${filtered.length}件`);
    }

    function filterByTag(tag) {
        const filtered = masterData.filter(item => item.tags.includes(tag));
        renderDictionary(filtered, tag);
        finalizeFilter(`タグ「#${tag}」の結果: ${filtered.length}件`);
    }

    function renderDictionary(data, query = "") {
        const list = document.getElementById('dictionaryList');
        if (data.length === 0) {
            list.innerHTML = "<div style='text-align:center; padding:40px; opacity:0.6;'>該当なし</div>";
            return;
        }
        list.innerHTML = data.map(item => `
            <div class="dic-card" data-cat="${item.category}">
                <div class="term-en">${highlight(item.term_en, query)}</div>
                <div class="term-jp">${item.term_jp}</div>
                <p class="desc">${highlight(item.description, query)}</p>
                <div class="card-tags">
                    ${item.tags.map(tag => `<span class="card-tag" onclick="filterByTag('${tag}')">#${tag}</span>`).join('')}
                </div>
            </div>
        `).join('');
    }

    function highlight(text, q) {
        if (!q || q.length < 1) return text;
        const re = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, "gi");
        return text.replace(re, `<span class="highlight">$1</span>`);
    }

    function clearActiveStates() {
        document.querySelectorAll('.btn-index').forEach(el => el.classList.remove('active'));
    }

    function finalizeFilter(message) {
        const status = document.getElementById('resultStatus');
        const msg = document.getElementById('statusMessage');
        status.classList.add('show');
        msg.innerText = message;
        window.scrollTo({ top: status.offsetTop - 20, behavior: 'smooth' });
    }

    function resetSearch() {
        clearActiveStates();
        document.getElementById('resultStatus').classList.remove('show');
        document.getElementById('dicSearch').value = "";
        renderDictionary(masterData);
    }

    function toHiragana(src) {
        return src.replace(/[\u30a1-\u30f6]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60));
    }

    document.getElementById('dicSearch').addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        if(q === "") {
            document.getElementById('resultStatus').classList.remove('show');
            renderDictionary(masterData);
        } else {
            const filtered = masterData.filter(item => 
                item.term_en.toLowerCase().includes(q) || item.term_jp.includes(q) || 
                (item.reading && item.reading.includes(q)) || item.description.includes(q)
            );
            renderDictionary(filtered, q);
            document.getElementById('resultStatus').classList.add('show');
            document.getElementById('statusMessage').innerText = `「${q}」の検索結果: ${filtered.length}件`;
        }
    });

    window.onload = init;
</script>
</body>
</html>